<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem BSI PRO - Hafiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <div id="auth-section" class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-md border-t-8 border-blue-900">
            <h1 class="text-3xl font-black text-blue-900 text-center uppercase mb-2">BSI SYSTEM</h1>
            <p id="auth-subtitle" class="text-center text-gray-500 text-sm mb-6">Log masuk untuk semak tugasan</p>
            
            <div id="register-fields" class="hidden space-y-3 mb-3">
                <div class="grid grid-cols-2 gap-2">
                    <input type="text" id="reg-fname" placeholder="Nama Depan" class="p-3 border rounded-xl bg-gray-50 outline-none">
                    <input type="text" id="reg-lname" placeholder="Nama Belakang" class="p-3 border rounded-xl bg-gray-50 outline-none">
                </div>
                <select id="reg-platoon" class="w-full p-3 border rounded-xl bg-gray-50 outline-none">
                    <option value="">-- Pilih Platun --</option>
                </select>
            </div>

            <input type="email" id="email" placeholder="Email" class="w-full p-3 mb-3 border rounded-xl bg-gray-50 outline-none">
            <input type="password" id="password" placeholder="Password" class="w-full p-3 mb-6 border rounded-xl bg-gray-50 outline-none">
            
            <button id="btn-action" class="w-full bg-blue-900 text-white font-bold py-4 rounded-2xl hover:bg-blue-800 shadow-lg uppercase tracking-widest transition-all">Log Masuk</button>
            <button id="auth-toggle-btn" class="w-full mt-4 text-sm text-blue-700 font-bold underline">Tukar ke Pendaftaran</button>
        </div>
    </div>

    <div id="main-dashboard" class="hidden">
        <nav class="bg-blue-900 text-white p-4 sticky top-0 z-50 shadow-xl">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <span class="font-black text-xl tracking-tighter italic">BSI-PRO</span>
                <div class="hidden md:flex space-x-6 text-xs font-bold uppercase">
                    <button onclick="showPage('jadual-tugas')" class="hover:text-yellow-400">Jadual Tugas</button>
                    <button onclick="showPage('jadual-induk')" class="hover:text-yellow-400">Jadual Induk</button>
                    <button onclick="showPage('settings')" class="hover:text-yellow-400">Settings</button>
                    <button id="admin-nav" onclick="showPage('admin')" class="hidden bg-yellow-400 text-blue-900 px-2 py-1 rounded">Admin</button>
                </div>
                <button id="btn-logout" class="bg-red-600 px-4 py-2 rounded-xl text-xs font-bold uppercase hover:bg-red-700">Logout</button>
            </div>
        </nav>

        <main class="max-w-4xl mx-auto p-4 md:p-8">
            <div class="bg-white rounded-3xl p-6 shadow-sm border mb-6 flex justify-between items-center">
                <div>
                    <h2 id="welcome-msg" class="text-xl font-black text-gray-800 uppercase"></h2>
                    <p id="user-sub" class="text-xs text-gray-500 font-bold uppercase tracking-widest"></p>
                </div>
                <div class="text-right">
                    <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Status Tugas</p>
                    <p id="current-date-display" class="font-bold text-blue-900 italic"></p>
                </div>
            </div>

            <div id="dynamic-content" class="bg-white rounded-3xl shadow-xl p-6 border min-h-[400px]"></div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updatePassword } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
        import { getDatabase, ref, set, get, child, update, remove } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-database.js";

        // --- KONFIGURASI FIREBASE ---
        const firebaseConfig = {
        apiKey: "AIzaSyCQ9SBXkEILe6PZdmLyGBSFK63XhPM_V7o",
        authDomain: "bravorians-bsi.firebaseapp.com",
        databaseURL: "https://bravorians-bsi-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "bravorians-bsi",
        storageBucket: "bravorians-bsi.firebasestorage.app",
        messagingSenderId: "314220494464",
        appId: "1:314220494464:web:d3b21e9b742e1db86f7065"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const rdb = getDatabase(app);

        const JADUAL_2 = {
            1: ["ENTRY MC", "ENTRY KA", "ENTRY BAS"], 2: ["EXIT KB", "EXIT SBY#2", "EXIT MA"],
            3: ["ENTRY KC", "ENTRY BDL/Autogate", "ENTRY SBY#1"], 4: ["EXIT LORI", "EXIT BAS", "EXIT KD"],
            5: ["ENTRY MC", "ENTRY SBY#3", "ENTRY KB"], 6: ["EXIT MA", "EXIT SBY#1", "EXIT KC"],
            7: ["ENTRY SBY#2", "ENTRY BAS", "ENTRY KD"], 8: ["EXIT BAS", "EXIT KA", "EXIT SBY#3"],
            9: ["ENTRY KA", "ENTRY BAS", "ENTRY MC"], 10: ["EXIT SBY#2", "EXIT MA", "EXIT KB"],
            11: ["ENTRY SBY#1", "ENTRY KC", "ENTRY BDL/Autogate"], 12: ["EXIT KD", "EXIT LORI", "EXIT BAS"],
            13: ["ENTRY SBY#3", "ENTRY KB", "ENTRY MC"], 14: ["EXIT KC", "EXIT MA", "EXIT SBY#1"],
            15: ["ENTRY KD", "ENTRY SBY#2", "ENTRY BAS"], 16: ["EXIT SBY#3", "EXIT BAS", "EXIT KA"],
            17: ["ENTRY BAS", "ENTRY MC", "ENTRY KA"], 18: ["EXIT MA", "EXIT KB", "EXIT SBY#2"],
            19: ["ENTRY BDL/Autogate", "ENTRY SBY#1", "ENTRY KC"], 20: ["EXIT BAS", "EXIT KD", "EXIT LORI"],
            21: ["ENTRY KB", "ENTRY MC", "ENTRY SBY#3"], 22: ["EXIT SBY#1", "EXIT KC", "EXIT MA"],
            23: ["ENTRY BAS", "ENTRY KD", "ENTRY SBY#2"], 24: ["EXIT KA", "EXIT SBY#3", "EXIT BAS"]
        };

        const PLATOON_START_ROW = { 2: 2, 3: 1, 4: 20, 5: 13, 6: 16, 7: 17, 8: 6, 9: 3, 10: 10, 11: 7, 12: 24, 13: 15, 14: 22, 15: 5, 16: 14, 17: 19, 18: 8, 19: 9, 20: 12, 21: 21, 22: 4, 23: 11, 24: 18, 25: 23 };

        // POPULATE PLATOON
        const sel = document.getElementById('reg-platoon');
        for(let i=2; i<=25; i++) { let opt = document.createElement('option'); opt.value = i; opt.text = "Platun " + i; sel.appendChild(opt); }

        let isLogin = true;
        let userData = null;

        // AUTH ACTIONS
        document.getElementById('auth-toggle-btn').onclick = () => {
            isLogin = !isLogin;
            document.getElementById('register-fields').classList.toggle('hidden');
            document.getElementById('btn-action').innerText = isLogin ? "Log Masuk" : "Daftar Akaun";
        };

        document.getElementById('btn-action').onclick = async () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            if (isLogin) {
                try { await signInWithEmailAndPassword(auth, email, pass); } catch(e) { alert("Akses Ditolak."); }
            } else {
                const f = document.getElementById('reg-fname').value;
                const l = document.getElementById('reg-lname').value;
                const p = document.getElementById('reg-platoon').value;
                try {
                    const res = await createUserWithEmailAndPassword(auth, email, pass);
                    await set(ref(rdb, 'users/' + res.user.uid), { firstName: f, lastName: l, fullName: `${f} ${l}`, platoon: parseInt(p), role: "user", status: "pending" });
                    alert("Tunggu Kelulusan Admin."); location.reload();
                } catch(e) { alert(e.message); }
            }
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const snap = await get(child(ref(rdb), `users/${user.uid}`));
                if (snap.exists() && snap.val().status === "approved") {
                    userData = snap.val();
                    document.getElementById('auth-section').classList.add('hidden');
                    document.getElementById('main-dashboard').classList.remove('hidden');
                    document.getElementById('welcome-msg').innerText = userData.fullName;
                    document.getElementById('user-sub').innerText = `PLT ${userData.platoon}`;
                    if(userData.role === 'admin') document.getElementById('admin-nav').classList.remove('hidden');
                    showPage('jadual-tugas');
                } else { signOut(auth); }
            } else {
                document.getElementById('auth-section').classList.remove('hidden');
                document.getElementById('main-dashboard').classList.add('hidden');
            }
        });

        document.getElementById('btn-logout').onclick = () => signOut(auth);

        // CORE FORMULA
        function calculateDuty(targetDate, platoon) {
            const baseDate = new Date(2026, 0, 3);
            const diffDays = Math.floor((targetDate - baseDate) / (1000 * 60 * 60 * 24));
            if (diffDays < 0 || diffDays % 4 === 3) return { off: true };
            const cycleCount = Math.floor(diffDays / 4);
            const column = diffDays % 4; 
            const currentRow = ((PLATOON_START_ROW[platoon] + cycleCount - 1) % 24) + 1;
            return { off: false, shift: ["PETANG", "PAGI", "MALAM"][column], baris: currentRow, kolum: column + 1, type: JADUAL_2[currentRow][column] };
        }

        window.showPage = async (page) => {
            const content = document.getElementById('dynamic-content');
            content.innerHTML = "";
            const today = new Date();
            document.getElementById('current-date-display').innerText = today.toLocaleDateString('ms-MY', {weekday:'short', day:'2-digit', month:'short'});

            if (page === 'jadual-tugas') {
                const duty = calculateDuty(today, userData.platoon);
                if (duty.off) {
                    content.innerHTML = `<div class="text-center py-20 text-red-500 font-black text-4xl">HARI INI OFF (CUTI)</div>`;
                } else {
                    // AMBIL DATA EXCEL DARI DATABASE
                    const excelSnap = await get(child(ref(rdb), 'excelData'));
                    let counterInfo = "Tiada Maklumat Kaunter";
                    if(excelSnap.exists()){
                        const list = excelSnap.val();
                        const match = Object.values(list).find(item => 
                            item.Nama.toLowerCase() === userData.fullName.toLowerCase() && 
                            item.Tugasan.trim() === duty.type.trim()
                        );
                        if(match) counterInfo = match.No_Kaunter;
                    }

                    content.innerHTML = `
                        <h2 class="text-xl font-black text-blue-900 uppercase border-b pb-4 mb-6 italic tracking-tight">Maklumat Tugasan Harian</h2>
                        <div class="space-y-6">
                            <div class="bg-blue-900 p-8 rounded-[2.5rem] text-white shadow-2xl relative overflow-hidden">
                                <p class="text-blue-300 font-bold uppercase text-[10px] tracking-widest mb-1">Tugasan Semasa</p>
                                <h1 class="text-4xl font-black mb-8">${duty.type}</h1>
                                
                                <div class="bg-white/10 p-6 rounded-3xl border border-white/20 backdrop-blur-sm">
                                    <p class="text-blue-200 font-bold uppercase text-[10px] mb-1 italic">No. Kaunter Spesifik</p>
                                    <h2 class="text-3xl font-black text-yellow-400">${counterInfo}</h2>
                                </div>

                                <div class="mt-8 flex gap-3">
                                    <span class="bg-blue-800 px-4 py-1 rounded-full text-[9px] font-black uppercase tracking-widest border border-blue-700">${duty.shift}</span>
                                    <span class="bg-blue-800 px-4 py-1 rounded-full text-[9px] font-black uppercase tracking-widest border border-blue-700">Baris ${duty.baris}</span>
                                </div>
                            </div>
                        </div>`;
                }
            } else if (page === 'admin') {
                content.innerHTML = `
                    <h2 class="text-xl font-black text-red-600 uppercase mb-6">Admin Panel</h2>
                    <div class="bg-gray-50 p-6 rounded-3xl border-2 border-dashed border-gray-200 mb-8">
                        <p class="text-xs font-black uppercase text-gray-400 mb-4">Muat Naik Data Excel (.xlsx)</p>
                        <input type="file" id="excel-input" accept=".xlsx" class="mb-4 text-xs block w-full text-gray-500">
                        <button onclick="uploadExcel()" class="bg-blue-900 text-white px-6 py-2 rounded-xl text-xs font-bold uppercase hover:shadow-lg transition">Update Data Kaunter</button>
                    </div>
                    <div id="adm-list" class="space-y-3"></div>`;
                const snap = await get(child(ref(rdb), 'users'));
                snap.forEach(c => {
                    const u = c.val(); if(u.status === 'pending') {
                        document.getElementById('adm-list').innerHTML += `<div class="p-4 border rounded-2xl flex justify-between items-center bg-white shadow-sm">
                            <div><p class="font-bold text-sm">${u.fullName}</p><p class="text-[9px] font-bold text-gray-400 uppercase">Platun ${u.platoon}</p></div>
                            <button onclick="approve('${c.key}')" class="bg-green-600 text-white px-4 py-2 rounded-xl text-[9px] font-bold uppercase">Lulus</button>
                        </div>`;
                    }
                });
            } else if (page === 'settings') {
                content.innerHTML = `<h2 class="text-xl font-bold mb-4 uppercase">Settings</h2><div class="max-w-sm space-y-4"><input type="password" id="new-p" placeholder="Password Baru" class="w-full p-4 border rounded-2xl outline-none shadow-inner"><button onclick="updatePw()" class="w-full bg-blue-900 text-white font-bold py-4 rounded-2xl uppercase tracking-widest text-xs">Simpan</button></div>`;
            } else if (page === 'jadual-induk') {
                content.innerHTML = `<h2 class="text-xl font-black mb-6 uppercase border-b pb-2">Jadual Induk (30 Hari)</h2><div class="grid grid-cols-2 md:grid-cols-4 gap-3">` + 
                Array.from({length:30}).map((_, i) => {
                    const d = new Date(); d.setDate(d.getDate() + i);
                    const res = calculateDuty(d, userData.platoon);
                    return `<div class="p-4 border rounded-2xl ${res.off ? 'bg-red-50 opacity-60' : 'bg-green-50 shadow-sm'}">
                        <p class="text-[9px] font-bold text-gray-400 uppercase">${d.toLocaleDateString('ms-MY', {day:'2-digit', month:'short'})}</p>
                        <p class="font-black text-xs ${res.off ? 'text-red-600' : 'text-green-700'}">${res.off ? 'OFF' : res.shift}</p>
                    </div>`;
                }).join('') + `</div>`;
            }
        };

        window.uploadExcel = () => {
            const file = document.getElementById('excel-input').files[0];
            if(!file) return alert("Pilih fail .xlsx");
            const reader = new FileReader();
            reader.onload = async (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type:'array'});
                const firstSheet = workbook.SheetNames[0];
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheet]);
                
                // Clear old data and push new
                await remove(ref(rdb, 'excelData'));
                await set(ref(rdb, 'excelData'), jsonData);
                alert("Data Excel Berjaya Dikemaskini!");
            };
            reader.readAsArrayBuffer(file);
        };

        window.approve = async (id) => { await update(ref(rdb, 'users/'+id), {status:'approved'}); showPage('admin'); };
        window.updatePw = async () => { const p = document.getElementById('new-p').value; if(p.length < 6) return alert("Minima 6 aksara"); await updatePassword(auth.currentUser, p); alert("Berjaya"); };
    </script>
</body>
</html>
